define(["durandal/system","knockout"],function(e,t){function a(e){return void 0==e&&(e={}),e.closeOnDeactivate||(e.closeOnDeactivate=s.defaults.closeOnDeactivate),e.beforeActivate||(e.beforeActivate=s.defaults.beforeActivate),e.afterDeactivate||(e.afterDeactivate=s.defaults.afterDeactivate),e.affirmations||(e.affirmations=s.defaults.affirmations),e.interpretResponse||(e.interpretResponse=s.defaults.interpretResponse),e.areSameItem||(e.areSameItem=s.defaults.areSameItem),e}function n(t,a,n){return e.isArray(n)?t[a].apply(t,n):t[a](n)}function i(t,a,n,i,r){if(t&&t.deactivate){e.log("Deactivating",t);var o;try{o=t.deactivate(a)}catch(c){return e.error(c),i.resolve(!1),void 0}o&&o.then?o.then(function(){n.afterDeactivate(t,a,r),i.resolve(!0)},function(t){e.log(t),i.resolve(!1)}):(n.afterDeactivate(t,a,r),i.resolve(!0))}else t&&n.afterDeactivate(t,a,r),i.resolve(!0)}function r(t,a,i,r){if(t)if(t.activate){e.log("Activating",t);var o;try{o=n(t,"activate",r)}catch(c){return e.error(c),i(!1),void 0}o&&o.then?o.then(function(){a(t),i(!0)},function(t){e.log(t),i(!1)}):(a(t),i(!0))}else a(t),i(!0);else i(!0)}function o(t,a,n){return n.lifecycleData=null,e.defer(function(i){if(t&&t.canDeactivate){var r;try{r=t.canDeactivate(a)}catch(o){return e.error(o),i.resolve(!1),void 0}r.then?r.then(function(e){n.lifecycleData=e,i.resolve(n.interpretResponse(e))},function(t){e.error(t),i.resolve(!1)}):(n.lifecycleData=r,i.resolve(n.interpretResponse(r)))}else i.resolve(!0)}).promise()}function c(t,a,i,r){return i.lifecycleData=null,e.defer(function(o){if(t==a())return o.resolve(!0),void 0;if(t&&t.canActivate){var c;try{c=n(t,"canActivate",r)}catch(u){return e.error(u),o.resolve(!1),void 0}c.then?c.then(function(e){i.lifecycleData=e,o.resolve(i.interpretResponse(e))},function(t){e.error(t),o.resolve(!1)}):(i.lifecycleData=c,o.resolve(i.interpretResponse(c)))}else o.resolve(!0)}).promise()}function u(n,u){var s,l=t.observable(null);u=a(u);var v=t.computed({read:function(){return l()},write:function(e){v.viaSetter=!0,v.activateItem(e)}});return v.__activator__=!0,v.settings=u,u.activator=v,v.isActivating=t.observable(!1),v.canDeactivateItem=function(e,t){return o(e,t,u)},v.deactivateItem=function(t,a){return e.defer(function(e){v.canDeactivateItem(t,a).then(function(n){n?i(t,a,u,e,l):(v.notifySubscribers(),e.resolve(!1))})}).promise()},v.canActivateItem=function(e,t){return c(e,l,u,t)},v.activateItem=function(t,a){var n=v.viaSetter;return v.viaSetter=!1,e.defer(function(o){if(v.isActivating())return o.resolve(!1),void 0;v.isActivating(!0);var c=l();return u.areSameItem(c,t,s,a)?(v.isActivating(!1),o.resolve(!0),void 0):(v.canDeactivateItem(c,u.closeOnDeactivate).then(function(d){d?v.canActivateItem(t,a).then(function(d){d?e.defer(function(e){i(c,u.closeOnDeactivate,u,e)}).promise().then(function(){t=u.beforeActivate(t,a),r(t,l,function(e){s=a,v.isActivating(!1),o.resolve(e)},a)}):(n&&v.notifySubscribers(),v.isActivating(!1),o.resolve(!1))}):(n&&v.notifySubscribers(),v.isActivating(!1),o.resolve(!1))}),void 0)}).promise()},v.canActivate=function(){var e;return n?(e=n,n=!1):e=v(),v.canActivateItem(e)},v.activate=function(){var e;return n?(e=n,n=!1):e=v(),v.activateItem(e)},v.canDeactivate=function(e){return v.canDeactivateItem(v(),e)},v.deactivate=function(e){return v.deactivateItem(v(),e)},v.includeIn=function(e){e.canActivate=function(){return v.canActivate()},e.activate=function(){return v.activate()},e.canDeactivate=function(e){return v.canDeactivate(e)},e.deactivate=function(e){return v.deactivate(e)}},u.includeIn?v.includeIn(u.includeIn):n&&v.activate(),v.forItems=function(t){u.closeOnDeactivate=!1,u.determineNextItemToActivate=function(e,t){var a=t-1;return-1==a&&e.length>1?e[1]:a>-1&&a<e.length-1?e[a]:null},u.beforeActivate=function(e){var a=v();if(e){var n=t.indexOf(e);-1==n?t.push(e):e=t()[n]}else e=u.determineNextItemToActivate(t,a?t.indexOf(a):0);return e},u.afterDeactivate=function(e,a){a&&t.remove(e)};var a=v.canDeactivate;v.canDeactivate=function(n){return n?e.defer(function(e){function a(){for(var t=0;t<r.length;t++)if(!r[t])return e.resolve(!1),void 0;e.resolve(!0)}for(var i=t(),r=[],o=0;o<i.length;o++)v.canDeactivateItem(i[o],n).then(function(e){r.push(e),r.length==i.length&&a()})}).promise():a()};var n=v.deactivate;return v.deactivate=function(a){return a?e.defer(function(e){function n(n){v.deactivateItem(n,a).then(function(){r++,t.remove(n),r==o&&e.resolve()})}for(var i=t(),r=0,o=i.length,c=0;o>c;c++)n(i[c])}).promise():n()},v},v}var s,l={closeOnDeactivate:!0,affirmations:["yes","ok","true"],interpretResponse:function(a){return e.isObject(a)&&(a=a.can||!1),e.isString(a)?-1!==t.utils.arrayIndexOf(this.affirmations,a.toLowerCase()):a},areSameItem:function(e,t){return e==t},beforeActivate:function(e){return e},afterDeactivate:function(e,t,a){t&&a&&a(null)}};return s={defaults:l,create:u,isActivator:function(e){return e&&e.__activator__}}});