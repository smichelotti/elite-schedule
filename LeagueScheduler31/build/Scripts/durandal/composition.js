define(["durandal/system","durandal/viewLocator","durandal/binder","durandal/viewEngine","durandal/activator","jquery","knockout"],function(e,t,n,i,a,r,o){function s(e){for(var t=[],n={childElements:t,activeView:null},i=o.virtualElements.firstChild(e);i;)1==i.nodeType&&(t.push(i),i.getAttribute(x)&&(n.activeView=i)),i=o.virtualElements.nextSibling(i);return n.activeView||(n.activeView=t[0]),n}function c(){S--,0===S&&setTimeout(function(){for(var t=k.length;t--;)try{k[t]()}catch(n){e.error(n)}k=[]},1)}function l(e){delete e.activeView,delete e.viewElements}function u(t,n,i){if(i)n();else if(t.activate&&t.model&&t.model.activate){var a;try{a=e.isArray(t.activationData)?t.model.activate.apply(t.model,t.activationData):t.model.activate(t.activationData),a&&a.then?a.then(n,function(t){e.error(t),n()}):a||void 0===a?n():(c(),l(t))}catch(r){e.error(r)}}else n()}function d(){var t=this;if(t.activeView&&t.activeView.removeAttribute(x),t.child)try{t.model&&t.model.attached&&(t.composingNewView||t.alwaysTriggerAttach)&&t.model.attached(t.child,t.parent,t),t.attached&&t.attached(t.child,t.parent,t),t.child.setAttribute(x,!0),t.composingNewView&&t.model&&t.model.detached&&o.utils.domNodeDisposal.addDisposeCallback(t.child,function(){try{t.model.detached(t.child,t.parent,t)}catch(n){e.error(n)}})}catch(n){e.error(n)}t.triggerAttach=e.noop}function f(t){if(e.isString(t.transition)){if(t.activeView){if(t.activeView==t.child)return!1;if(!t.child)return!0;if(t.skipTransitionOnSameViewId){var n=t.activeView.getAttribute("data-view"),i=t.child.getAttribute("data-view");return n!=i}}return!0}return!1}function v(e){for(var t=0,n=e.length,i=[];n>t;t++){var a=e[t].cloneNode(!0);i.push(a)}return i}function g(e){var t=v(e.parts),n=w.getParts(t,null,!0),i=w.getParts(e.child);for(var a in n)r(i[a]).replaceWith(n[a])}function m(t){var n,i,a=o.virtualElements.childNodes(t.parent);if(!e.isArray(a)){var r=[];for(n=0,i=a.length;i>n;n++)r[n]=a[n];a=r}for(n=1,i=a.length;i>n;n++)o.removeNode(a[n])}function p(e){o.utils.domData.set(e,V,e.style.display),e.style.display="none"}function h(e){e.style.display=o.utils.domData.get(e,V)}function b(e){var t=e.getAttribute("data-bind");if(!t)return!1;for(var n=0,i=_.length;i>n;n++)if(t.indexOf(_[n])>-1)return!0;return!1}var w,y={},x="data-active-view",k=[],S=0,D="durandal-composition-data",I="data-part",A=["model","view","transition","area","strategy","activationData"],V="durandal-visibility-data",_=["compose:"],N={complete:function(e){k.push(e)}};return w={composeBindings:_,convertTransitionToModuleId:function(e){return"transitions/"+e},defaultTransitionName:null,current:N,addBindingHandler:function(e,t,n){var i,a,r="composition-handler-"+e;t=t||o.bindingHandlers[e],n=n||function(){return void 0},a=o.bindingHandlers[e]={init:function(e,i,a,s,c){if(S>0){var l={trigger:o.observable(null)};w.current.complete(function(){t.init&&t.init(e,i,a,s,c),t.update&&(o.utils.domData.set(e,r,t),l.trigger("trigger"))}),o.utils.domData.set(e,r,l)}else o.utils.domData.set(e,r,t),t.init&&t.init(e,i,a,s,c);return n(e,i,a,s,c)},update:function(e,t,n,i,a){var s=o.utils.domData.get(e,r);return s.update?s.update(e,t,n,i,a):(s.trigger&&s.trigger(),void 0)}};for(i in t)"init"!==i&&"update"!==i&&(a[i]=t[i])},getParts:function(e,t,n){if(t=t||{},!e)return t;void 0===e.length&&(e=[e]);for(var i=0,a=e.length;a>i;i++){var r=e[i];if(r.getAttribute){if(!n&&b(r))continue;var o=r.getAttribute(I);o&&(t[o]=r),!n&&r.hasChildNodes()&&w.getParts(r.childNodes,t)}}return t},cloneNodes:v,finalize:function(t){if(void 0===t.transition&&(t.transition=this.defaultTransitionName),t.child||t.activeView)if(f(t)){var i=this.convertTransitionToModuleId(t.transition);e.acquire(i).then(function(e){t.transition=e,e(t).then(function(){if(t.cacheViews){if(t.activeView){var e=n.getBindingInstruction(t.activeView);e&&void 0!=e.cacheViews&&!e.cacheViews&&o.removeNode(t.activeView)}}else t.child?m(t):o.virtualElements.emptyNode(t.parent);t.triggerAttach(),c(),l(t)})}).fail(function(t){e.error("Failed to load transition ("+i+"). Details: "+t.message)})}else{if(t.child!=t.activeView){if(t.cacheViews&&t.activeView){var a=n.getBindingInstruction(t.activeView);!a||void 0!=a.cacheViews&&!a.cacheViews?o.removeNode(t.activeView):p(t.activeView)}t.child?(t.cacheViews||m(t),h(t.child)):t.cacheViews||o.virtualElements.emptyNode(t.parent)}t.triggerAttach(),c(),l(t)}else t.cacheViews||o.virtualElements.emptyNode(t.parent),t.triggerAttach(),c(),l(t)},bindAndShow:function(e,t,a){t.child=e,t.composingNewView=t.cacheViews?-1==o.utils.arrayIndexOf(t.viewElements,e):!0,u(t,function(){if(t.binding&&t.binding(t.child,t.parent,t),t.preserveContext&&t.bindingContext)t.composingNewView&&(t.parts&&g(t),p(e),o.virtualElements.prepend(t.parent,e),n.bindContext(t.bindingContext,e,t.model));else if(e){var a=t.model||y,r=o.dataFor(e);if(r!=a){if(!t.composingNewView)return o.removeNode(e),i.createView(e.getAttribute("data-view")).then(function(e){w.bindAndShow(e,t,!0)}),void 0;t.parts&&g(t),p(e),o.virtualElements.prepend(t.parent,e),n.bind(a,e)}}w.finalize(t)},a)},defaultStrategy:function(e){return t.locateViewForObject(e.model,e.area,e.viewElements)},getSettings:function(t){var n,r=t(),s=o.utils.unwrapObservable(r)||{},c=a.isActivator(r);if(e.isString(s))return s=i.isViewUrl(s)?{view:s}:{model:s,activate:!0};if(n=e.getModuleId(s))return s={model:s,activate:!0};!c&&s.model&&(c=a.isActivator(s.model));for(var l in s)s[l]=-1!=o.utils.arrayIndexOf(A,l)?o.utils.unwrapObservable(s[l]):s[l];return c?s.activate=!1:void 0===s.activate&&(s.activate=!0),s},executeStrategy:function(e){e.strategy(e).then(function(t){w.bindAndShow(t,e)})},inject:function(n){return n.model?n.view?(t.locateView(n.view,n.area,n.viewElements).then(function(e){w.bindAndShow(e,n)}),void 0):(n.strategy||(n.strategy=this.defaultStrategy),e.isString(n.strategy)?e.acquire(n.strategy).then(function(e){n.strategy=e,w.executeStrategy(n)}).fail(function(t){e.error("Failed to load view strategy ("+n.strategy+"). Details: "+t.message)}):this.executeStrategy(n),void 0):(this.bindAndShow(null,n),void 0)},compose:function(n,i,a,r){S++,r||(i=w.getSettings(function(){return i},n)),i.compositionComplete&&k.push(function(){i.compositionComplete(i.child,i.parent,i)}),k.push(function(){i.composingNewView&&i.model&&i.model.compositionComplete&&i.model.compositionComplete(i.child,i.parent,i)});var o=s(n);i.activeView=o.activeView,i.parent=n,i.triggerAttach=d,i.bindingContext=a,i.cacheViews&&!i.viewElements&&(i.viewElements=o.childElements),i.model?e.isString(i.model)?e.acquire(i.model).then(function(t){i.model=e.resolveObject(t),w.inject(i)}).fail(function(t){e.error("Failed to load composed module ("+i.model+"). Details: "+t.message)}):w.inject(i):i.view?(i.area=i.area||"partial",i.preserveContext=!0,t.locateView(i.view,i.area,i.viewElements).then(function(e){w.bindAndShow(e,i)})):this.bindAndShow(null,i)}},o.bindingHandlers.compose={init:function(){return{controlsDescendantBindings:!0}},update:function(e,t,n,a,r){var s=w.getSettings(t,e);if(s.mode){var c=o.utils.domData.get(e,D);if(!c){var l=o.virtualElements.childNodes(e);c={},"inline"===s.mode?c.view=i.ensureSingleElement(l):"templated"===s.mode&&(c.parts=v(l)),o.virtualElements.emptyNode(e),o.utils.domData.set(e,D,c)}"inline"===s.mode?s.view=c.view.cloneNode(!0):"templated"===s.mode&&(s.parts=c.parts),s.preserveContext=!0}w.compose(e,s,r,!0)}},o.virtualElements.allowedBindings.compose=!0,w});